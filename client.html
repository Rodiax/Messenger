<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger</title>

    <style>
        :root {
            --background: #00203FFF;
            --bubble: #9CC3D5FF;
            --bubble-text: #021C1E;

            --submit-button: rgba(0, 255, 0, 0.897);
            --submit-button-darken: rgba(0, 255, 0, 0.801);
            --submit-button-text: white;

            --text-input: #F5F5F5;
            --text-input-background: #063852;

            --app-border-radius: .7rem;
        }

        *,
        :before,
        :after {
            box-sizing: border-box;

            margin: 0;
            padding: 0;

            outline: none;
        }

        html, body {
            height: 100%;
        }

        html {
            font-size: 62.5%;
        }

        body {
            display: flex;

            justify-content: center;
        }

        .messenger {
            height: 100%;
            width: 90rem;

            display: flex;
            flex-direction: column;
            justify-content: space-between;

            padding: 1rem;
        }

        .messenger__top {
            flex-basis: 78%;

            background-color: var(--background);

            border-radius: var(--app-border-radius);

            overflow-y: auto;

            padding: 1rem;
        }

        .messenger__text {
            font-size: 1.6rem;
            font-family: Verdana, Geneva, Tahoma, sans-serif;

            padding: 2rem;

            margin-bottom: 2rem;

            background-color: var(--bubble);
            color: var(--bubble-text);

            display: inline-block;

            border-radius: var(--app-border-radius);

            max-width: 60%;

            overflow-wrap: break-word;
        }

        .messenger__bottom {
            flex-basis: 20%;

            background-color: var(--background);

            border-radius: var(--app-border-radius);

            padding: 1rem;
        }

        .text-form {
            height: 100%;

            display: flex;
            justify-content: space-between;
        }

        .text-form__input {            
            flex-basis: calc(80% - 1rem);

            padding: 1rem 1.5rem;

            resize: none;

            font-size: 1.4rem;
            font-family: Verdana, Geneva, Tahoma, sans-serif;

            border: none;
            border-radius: var(--app-border-radius);

            background-color: var(--text-input-background);
            color: var(--text-input);
        }

        .text-form__submit-btn {
            background-color: var(--submit-button);
            color: var(--submit-button-text);

            flex-basis: 20%;

            border: none;
            border-radius: var(--app-border-radius);

            font-size: 1.4rem;
            font-family: Verdana, Geneva, Tahoma, sans-serif;

            cursor: pointer;

            transition: background .2s linear;
        }

        .text-form__submit-btn:hover {
            background-color: var(--submit-button-darken);
        }

        .text-right {
            text-align: right;
        }

        .text-left {
            text-align: left;
        }

        .mb-10 {
            margin-bottom: 1rem;
        }

        .no-wrap {
            white-space: nowrap;
        }

        .status {
            position: fixed;

            width: 20rem;
            padding: 1rem;

            border-radius: var(--app-border-radius);

            top: 1rem;
            left: 1rem;

            background: var(--background);

            font-size: 1.4rem;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            color: var(--bubble);        
        }

        .status__icon {
            border-radius: 50%;
            
            width: 1rem;
            height: 1rem;

            display: inline-block;

            vertical-align: middle;
        }

        .status__icon--red {
            background-color: rgba(255, 0, 0, 0.603);
        }

        .status__icon--green {
            background-color: rgba(0, 255, 0, 0.897);
        }

        .status__row {
            display: flex;
            
            justify-content: space-between;
        }

        .status__username {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status__divider {
            border-top: 1px solid var(--bubble);

            margin: 1rem 0;
        }

        @media screen and (max-width: 1325px) {
            .status {
                position: static;

                width: 100%;

                margin-bottom: 1rem;
            }

            .messenger__top {
                margin-bottom: 1rem;
            }
        } 
    </style>
</head>
<body>
    
    

    <div class="messenger">
        <div class="status">
            <div class="status__row mb-10">
                <div>Name:</div>
                <div>
                    <span class="status__activity">offline</span> 
                    <i class="status__icon status__icon--red"></i>
                </div>
            </div>
            <div class="status__row">
                <div class="status__username">&mdash;</div>
            </div>

            <div class="status__divider"></div>

            <div class="status__row mb-10">
                <div>Users in room:</div>
                <div class="status__count">1</div>
            </div>

            <div class="status__users"></div>
        </div>

        <div class="messenger__top"></div>

        <div class="messenger__bottom">
            <form method="post" class="text-form">
                <textarea name="message" class="text-form__input"></textarea>
                <button type="submit" class="text-form__submit-btn">Send message</button>
            </form>
        </div>
    </div>
    
    <script>
        /** Websocket
        ********************************************************************/
        var ws = (function initializeConnection() {
            const connection = new WebSocket("ws://127.0.0.1:4080");

            connection.onopen = () => { 
                addMessage("Connection estabilished.");

                statusIcon.classList.remove('status__icon--red');
                statusIcon.classList.add('status__icon--green');

                statusActivity.innerText = "online";
            };

            connection.onclose = () => {
                const timer = 3000;
                const msg = addMessage("Connection failed!", 'trying to reconnect:', timer / 1000)({ firstTextNodeClass: 'mb-10' });
                const interval = setInterval(() => {
                    let seconds = msg.textNodes[msg.textNodes.length - 1].textContent;
                    msg.textNodes[msg.textNodes.length - 1].textContent = --seconds;
                    
                    if (seconds < 1) {
                        clearInterval(interval);
                        addMessage('Connecting...');

                        ws = initializeConnection();
                    }
                }, 1000);                

                statusIcon.classList.remove('status__icon--green');
                statusIcon.classList.add('status__icon--red');

                statusActivity.innerText = "offline";
            };

            connection.onmessage = response => { 
                const data = JSON.parse(response.data);
                
                if (!data.settings) {
                    addMessage(`Message from: ${data.name}`,  data.message)({ textBlockClass: 'text-right', firstTextNodeClass: 'mb-10' });  
                } else {
                    statusUser.textContent = data.clientName;
                    statusCount.textContent = data.connectedUsers.length;
                    
                    statusUsers.innerHTML = ""; // Will clear old nodes
                    data.connectedUsers.filter((user, i) => i < 2).forEach(user => {
                        const node = document.createElement('div');
                        node.innerText = user;

                        statusUsers.appendChild(node);
                    });

                    if (data.connectedUsers.length > 2) {
                        const others = data.connectedUsers.filter((user, i) => i >= 2);
                        const node = document.createElement('div');
                        node.innerText = `And other users (${others.length})`;
                        node.title = others.join(", ");

                        statusUsers.appendChild(node);
                    }
                }
            };

            return connection;
        })();

        /** Node elements
        ********************************************************************/
        const textForm = document.querySelector('.text-form');
        const textInput = document.querySelector('.text-form__input');
        const textSubmitButton = document.querySelector('.text-form__submit-btn');

        const chatWindow = document.querySelector('.messenger__top');

        const statusActivity = document.querySelector('.status__activity');
        const statusUser = document.querySelector('.status__username');
        const statusIcon = document.querySelector('.status__icon');
        const statusCount = document.querySelector('.status__count');
        const statusUsers = document.querySelector('.status__users');
        

        /** App
        ********************************************************************/
        textForm.onsubmit = event => {
            event.preventDefault();

            handleFormSubmit();
        };

        textInput.onkeydown = event => {
            if (event.keyCode == 13 && !event.shiftKey) {
                event.preventDefault();
                
                handleFormSubmit();
            }
        };
        

        /** Utils
        ********************************************************************/
        const addMessage = (...message) => {
            const textBlock = document.createElement('div');
            const textWrapper = document.createElement('div');
            
            textWrapper.className = "messenger__text text-left";

            message.forEach(msg => {
                const textNode = document.createElement('div');
                textNode.innerText = msg;

                textWrapper.appendChild(textNode);    
            });

            textBlock.appendChild(textWrapper);
            chatWindow.appendChild(textBlock);

            chatWindow.scrollTop = chatWindow.scrollHeight;

            return options => {
                if (options.textBlockClass)
                    textBlock.className = options.textBlockClass;

                if (options.firstTextNodeClass)   
                    textWrapper.children[0].className = options.firstTextNodeClass;

                return {
                    textNodes: textWrapper.childNodes
                };
            };
        };

        const handleFormSubmit = () => {
            if (!textInput.value.length || /^(\s|\n)+$/g.test(textInput.value)) return;

            addMessage('You said:', textInput.value)({ firstTextNodeClass: 'mb-10' });

            ws.send(textInput.value);

            textForm.reset();
        }

        
    </script>
    
</body>
</html>